<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vivid Web Control</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: #1a1a2e;
            color: #eee;
            min-height: 100vh;
            padding: 20px;
        }
        h1 {
            text-align: center;
            margin-bottom: 30px;
            color: #4fc3f7;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
        }
        .status {
            text-align: center;
            padding: 10px;
            margin-bottom: 20px;
            border-radius: 8px;
            background: #16213e;
        }
        .status.connected { border-left: 4px solid #4caf50; }
        .status.disconnected { border-left: 4px solid #f44336; }
        .operator {
            background: #16213e;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .operator h2 {
            color: #4fc3f7;
            margin-bottom: 15px;
            font-size: 1.2em;
        }
        .param {
            margin-bottom: 15px;
        }
        .param label {
            display: block;
            margin-bottom: 5px;
            color: #aaa;
            font-size: 0.9em;
        }
        .param-row {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .param input[type="range"] {
            flex: 1;
            height: 8px;
            border-radius: 4px;
            background: #0f3460;
            outline: none;
            -webkit-appearance: none;
        }
        .param input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #4fc3f7;
            cursor: pointer;
        }
        .param .value {
            min-width: 60px;
            text-align: right;
            font-family: monospace;
            color: #4fc3f7;
        }
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .loading { animation: pulse 1.5s infinite; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéõÔ∏è Vivid Web Control</h1>
        <div id="status" class="status disconnected">Connecting...</div>
        <div id="operators" class="loading">Loading operators...</div>
    </div>

    <script>
        const API_BASE = '';  // Same origin
        let ws = null;

        // Fetch operator list
        async function fetchOperators() {
            try {
                const res = await fetch('/api/operators');
                const ops = await res.json();
                return ops;
            } catch (e) {
                console.error('Failed to fetch operators:', e);
                return [];
            }
        }

        // Fetch operator details
        async function fetchOperator(name) {
            try {
                const res = await fetch(`/api/operator/${name}`);
                const data = await res.json();
                return data;
            } catch (e) {
                console.error(`Failed to fetch operator ${name}:`, e);
                return null;
            }
        }

        // Set parameter value
        async function setParam(operatorName, paramName, value) {
            try {
                await fetch(`/api/operator/${operatorName}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ param: paramName, value: value })
                });
            } catch (e) {
                console.error('Failed to set param:', e);
            }
        }

        // Render operator UI
        function renderOperator(op) {
            if (!op.params || op.params.length === 0) return '';

            let html = `<div class="operator"><h2>${op.name}</h2>`;
            for (const p of op.params) {
                const step = (p.max - p.min) / 100;
                html += `
                    <div class="param">
                        <label>${p.name}</label>
                        <div class="param-row">
                            <input type="range"
                                   id="${op.name}_${p.name}"
                                   min="${p.min}"
                                   max="${p.max}"
                                   step="${step}"
                                   value="${p.value}"
                                   oninput="onSliderChange('${op.name}', '${p.name}', this.value)">
                            <span class="value" id="${op.name}_${p.name}_val">${p.value.toFixed(2)}</span>
                        </div>
                    </div>
                `;
            }
            html += '</div>';
            return html;
        }

        // Handle slider change
        function onSliderChange(opName, paramName, value) {
            const val = parseFloat(value);
            document.getElementById(`${opName}_${paramName}_val`).textContent = val.toFixed(2);
            setParam(opName, paramName, val);
        }

        // Initialize WebSocket
        function connectWebSocket() {
            const wsUrl = `ws://${window.location.host}/ws`;
            ws = new WebSocket(wsUrl);

            ws.onopen = () => {
                document.getElementById('status').className = 'status connected';
                document.getElementById('status').textContent = 'Connected';
            };

            ws.onclose = () => {
                document.getElementById('status').className = 'status disconnected';
                document.getElementById('status').textContent = 'Disconnected - Reconnecting...';
                setTimeout(connectWebSocket, 2000);
            };

            ws.onmessage = (event) => {
                try {
                    const msg = JSON.parse(event.data);
                    if (msg.type === 'paramChange') {
                        // Update UI when parameter changes externally
                        const slider = document.getElementById(`${msg.data.operator}_${msg.data.param}`);
                        const valSpan = document.getElementById(`${msg.data.operator}_${msg.data.param}_val`);
                        if (slider) slider.value = msg.data.value;
                        if (valSpan) valSpan.textContent = msg.data.value.toFixed(2);
                    }
                } catch (e) {}
            };
        }

        // Initialize
        async function init() {
            const operators = await fetchOperators();
            let html = '';

            for (const op of operators) {
                const details = await fetchOperator(op.name);
                if (details) {
                    html += renderOperator(details);
                }
            }

            if (html === '') {
                html = '<div class="loading">No controllable operators found</div>';
            }

            document.getElementById('operators').innerHTML = html;
            connectWebSocket();
        }

        init();
    </script>
</body>
</html>
